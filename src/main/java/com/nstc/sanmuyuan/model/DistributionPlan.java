package com.nstc.sanmuyuan.model;

import java.sql.SQLException;
import java.util.List;

import com.jfinal.plugin.activerecord.ActiveRecordException;
import com.jfinal.plugin.activerecord.Db;
import com.jfinal.plugin.activerecord.IAtom;
import com.nstc.sanmuyuan.model.base.BaseDistributionPlan;

/**
 * Generated by JFinal.
 */
@SuppressWarnings("serial")
public class DistributionPlan extends BaseDistributionPlan<DistributionPlan> {
	public static final DistributionPlan dao = new DistributionPlan();

	public List<DistributionPlan> list() {
		StringBuffer subquery = new StringBuffer();
		subquery.append("select pi.planid, group_concat((c.cname || ' ' || pi.itemnumber)");
		subquery.append(" order by pi.cid separator '  ' ) as detail");
		subquery.append(" from plan_item pi left join COMMODITIES c on c.cid = pi.cid");
		subquery.append(" group by pi.planid");

		StringBuffer sql = new StringBuffer();
		sql.append("select dp.planid, dp.orderid,dp.plandate, p.productid, p.productname productname, t.detail,");
		sql.append("	(case dp.planstate when '1' then '未配送' when '2' then '已配送' end ) planstate, dp.remark");
		sql.append(" from sanmuyuan.distribution_plan dp ");
		sql.append(" left join product p on dp.productid = p.productid ");
		sql.append(" left join(" + subquery.toString() + ") t on t.planid = dp.planid");
		return find(sql.toString());
	}

	public DistributionPlan info(String strPlanid) {
		DistributionPlan distributionPlan = findById(strPlanid);

		StringBuffer sql = new StringBuffer("select pi.itemid,pi.planid,pi.itemnumber,pi.cid,c.cname ");
		sql.append(" from PLAN_ITEM pi left join COMMODITIES c on c.cid = pi.cid");
		sql.append(" where pi.planid = ?");
		sql.append(" ORDER BY pi.cid ");

		List<PlanItem> items = PlanItem.dao.find(sql.toString(), distributionPlan.getPlanid());
		distributionPlan.put("items", items);
		return distributionPlan;

	}

	public boolean save(DistributionPlan distributionPlan, List<PlanItem> items) throws Exception {
		try {
			return Db.tx(new IAtom() {

				@Override
				public boolean run() throws SQLException {
					boolean res = false;
					distributionPlan.setRemark(distributionPlan.getRemark() == null ? "" : distributionPlan.getRemark());
					res = distributionPlan.save();
					if (res) {
						Long planid = distributionPlan.getPlanid();
						for (PlanItem planItem : items) {
							planItem.setPlanid(planid);
							res = planItem.save();
							if (!res) {
								break;
							}
						}
					}

					return res;
				}
			});
		} catch (ActiveRecordException e) {
			throw new Exception(e);
		}
	}

	public boolean update(DistributionPlan distributionPlan, List<PlanItem> items) throws Exception {
		boolean reslut = false;
		try {
			reslut = Db.tx(new IAtom() {
				@Override
				public boolean run() throws SQLException {
					boolean res = false;
					res = distributionPlan.update();
					if (res) {
						for (PlanItem planItem : items) {
							res = planItem.update();
							if (!res) {
								break;
							}
						}
					}
					return res;
				}
			});
		} catch (ActiveRecordException e) {
			throw new Exception(e);
		}
		return reslut;
	}

	public boolean del(String strPlanid) throws Exception {
		boolean reslut = false;
		try {
			reslut = Db.tx(new IAtom() {

				@Override
				public boolean run() throws SQLException {
					boolean res = false;
					res = deleteById(strPlanid);
					if (res) {
						int ret = Db.update("delete from PLAN_ITEM where planid = ?", strPlanid);
						if (ret <= 0) {
							res = false;
						}
					}
					return res;
				}
			});
		} catch (ActiveRecordException e) {
			throw new Exception(e);
		}
		return reslut;
	}

}
